---
const currentPath = Astro.url.pathname;

const productSubmenu = [
  { href: '/products/pre-crimped-wire-assembly', label: 'Pre-Crimped Wire Assemblies' },
  { href: '/products/wire-to-board-cable-assembly', label: 'Wire-to-Board Assemblies' },
  { href: '/products/wire-to-wire-cable-assembly', label: 'Wire-to-Wire Assemblies' },
  { type: 'divider' },
  { href: '/products/jst-compatible-wire-assembly', label: 'JST Compatible' },
  { href: '/products/molex-compatible-wire-assembly', label: 'Molex Compatible' },
  { href: '/products/te-compatible-wire-assembly', label: 'TE Compatible' },
  { href: '/products/hirose-compatible-wire-assembly', label: 'Hirose Compatible' },
  { href: '/products/dupont-compatible-wire-assembly', label: 'DuPont Compatible' }
];

const navItems = [
  { href: '/', label: 'Home' },
  { href: '/products', label: 'Products', hasSubmenu: true },
  { href: '/compatibility', label: 'Compatibility' },
  { href: '/applications', label: 'Applications' },
  { href: '/oem-wire-cable-assembly-manufacturer', label: 'OEM Services' },
  { href: '/contact', label: 'Contact' }
];
---

<header class="fixed top-0 left-0 right-0 z-50 bg-bg-primary/90 backdrop-blur-sm border-b border-border transition-shadow duration-300" id="main-header">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <a href="/" class="logo font-mono text-xl font-extrabold text-accent-cyan tracking-tight relative">
      Trycay
      <span class="absolute -right-5 top-1/2 -translate-y-1/2 text-[0.6em] text-accent-amber">â–²</span>
    </a>

    <nav class="hidden md:flex gap-8 items-center">
      {navItems.map(item => (
        item.hasSubmenu ? (
          <div class="relative group">
            <a
              href={item.href}
              class:list={[
                "font-mono text-xs font-medium text-text-secondary uppercase tracking-wider relative transition-colors flex items-center gap-1",
                { "text-accent-cyan": currentPath === item.href || currentPath.startsWith('/products/') }
              ]}
            >
              {item.label}
              <svg class="w-3 h-3 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </a>
            <!-- Submenu -->
            <div class="absolute left-0 top-full mt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
              <div class="bg-bg-secondary border border-border rounded-lg shadow-lg py-2 min-w-[280px]">
                {productSubmenu.map((sub) => (
                  sub.type === 'divider' ? (
                    <div class="border-t border-border my-2 mx-2"></div>
                  ) : (
                    <a
                      href={sub.href}
                      class:list={[
                        "block px-4 py-2 font-mono text-sm text-text-secondary hover:text-accent-cyan hover:bg-bg-tertiary transition-colors",
                        { "text-accent-cyan bg-accent-cyan/10": currentPath === sub.href }
                      ]}
                    >
                      {sub.label}
                    </a>
                  )
                ))}
              </div>
            </div>
          </div>
        ) : (
          <a
            href={item.href}
            class:list={[
              "font-mono text-xs font-medium text-text-secondary uppercase tracking-wider relative transition-colors",
              { "text-accent-cyan": currentPath === item.href }
            ]}
          >
            {item.label}
          </a>
        )
      ))}
    </nav>

    <!-- Mobile Menu Button -->
    <button class="md:hidden text-text-secondary" id="mobile-menu-btn" aria-label="Toggle menu">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </div>

  <!-- Mobile Menu -->
  <nav class="md:hidden hidden bg-bg-secondary border-t border-border" id="mobile-menu">
    <div class="px-4 py-2 space-y-1">
      {navItems.map(item => (
        item.hasSubmenu ? (
          <div class="py-2">
            <div class:list={[
              "px-3 py-2 font-mono text-sm text-text-secondary uppercase tracking-wider rounded flex items-center justify-between",
              { "text-accent-cyan": currentPath === item.href }
            ]}>
              {item.label}
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
            <div class="ml-4 mt-1 space-y-1">
              {productSubmenu.map((sub) => (
                sub.type === 'divider' ? (
                  <div class="border-t border-border my-2"></div>
                ) : (
                  <a
                    href={sub.href}
                    class:list={[
                      "block px-3 py-2 font-mono text-xs text-text-secondary hover:text-accent-cyan hover:bg-bg-tertiary rounded transition-colors",
                      { "text-accent-cyan bg-accent-cyan/10": currentPath === sub.href }
                    ]}
                  >
                    {sub.label}
                  </a>
                )
              ))}
            </div>
          </div>
        ) : (
          <a
            href={item.href}
            class:list={[
              "block px-3 py-2 font-mono text-sm text-text-secondary uppercase tracking-wider rounded",
              { "bg-accent-cyan/10 text-accent-cyan": currentPath === item.href }
            ]}
          >
            {item.label}
          </a>
        )
      ))}
    </div>
  </nav>

</header>

<script define:vars={{ headerInitialBg: 'rgba(10, 14, 23, 0.9)', headerScrolledBg: 'rgba(10, 14, 23, 0.98)' }}>
  const header = document.getElementById('main-header');
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');

  // Mobile menu toggle
  mobileMenuBtn?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
  });

  // Header scroll effect - optimized to prevent forced reflows
  if (header) {
    let ticking = false;
    let isScrolled = false;

    // Set initial background
    header.style.background = headerInitialBg;

    const updateHeader = (scrolled) => {
      // Use a state variable instead of reading classList (prevents reflow)
      if (scrolled !== isScrolled) {
        isScrolled = scrolled;
        if (scrolled) {
          header.classList.add('shadow-lg', 'shadow-accent-cyan/10');
          header.style.background = headerScrolledBg;
        } else {
          header.classList.remove('shadow-lg', 'shadow-accent-cyan/10');
          header.style.background = headerInitialBg;
        }
      }
    };

    // Use passive listener for better scroll performance
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateHeader(window.scrollY > 100);
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });
  }
</script>

<style>
  /* Optimized transition to prevent layout thrashing */
  #main-header {
    transition: box-shadow 0.3s ease, background-color 0.3s ease;
  }

  nav a::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 0;
    height: 1px;
    background: #00d4ff;
    transition: width 0.3s;
  }

  nav a:hover::after {
    width: 100%;
  }

  /* Submenu arrow animation */
  nav a svg {
    transition: transform 0.3s ease;
  }
</style>
